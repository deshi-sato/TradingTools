# DeepNaut 開発記録（2025-10-10）

## テーマ
BUY判定側の特徴量改修と自動閾値最適化フロー確立（stream_microbatch → grid_search_thresholds → auto_tune）

## 1. stream_microbatch改修
- f1_delta: f1の変化率（シンボル単位差分, [-5,5]クリップ）
- f2,f3: 移動平均(5本)平滑化で連続化
- score: 1〜99%パーセンタイル→[0,10]再スケール
- features_streamにf1_delta列自動追加

## 2. 再学習パイプライン
```powershell
py -m scripts.build_labels_from_replay -DatasetId REF20251010_OFF
py -m scripts.build_training_set -DatasetId REF20251010_OFF
py -u -m scripts.grid_search_thresholds -DatasetId REF20251010_OFF
```
結果: precision=1.0, EV=13.625, trades=3件

## 3. 分布分析
- f2,f3: 0/10固定→改善
- score: 飽和解消
- f1 vs spread_ticks: -0.98高相関→f1_delta導入で解消
- 分布ヒートマップ・相関図・EV散布で連続性確認

## 4. 進捗表示
- `py -u`実行でリアルタイム出力化
- ETA付き進行率表示パッチ追加済み

## 5. auto_tune_buy_thresholds.py
- grid_search_thresholdsを段階的に呼出し、BUY閾値を自動緩和
- ラウンドごとに BUY_UPTICK_THR -0.05, BUY_SPREAD_MAX +2, BUY_SCORE_THR -0.5
- 目標 trades≥10で停止
- EVFloor引数修正 (-EVfloor→-EVFloor)

## 6. 現状まとめ
|項目|状況|
|-|-|
|stream_microbatch|f1_delta/平滑化/スケーリング実装完了|
|build_training_set|f1_delta対応済み|
|grid_search_thresholds|進捗表示＆flush対応済み|
|auto_tune_buy_thresholds|機能完成, EVFloor修正済み|
|特徴量分布|連続化成功, 相関正常化|
|残課題|trades件数拡大（BUY_SCORE_THR/BUY_SPREAD_MAX調整）|

## 7. 次フェーズ
1. SELL側自動チューナー導入
2. BUY/SELL統合閾値自動反映
3. build_training_setにf1_deltaを正式列として組込
4. MLモデル(scikit-learn/XGBoost)導入→閾値自動学習
