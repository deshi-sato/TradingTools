<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sentinel Debug Dashboard</title>
<style>
body { font-family: Consolas, monospace; background: #0e0e10; color: #dcdcdc; margin: 2em; }
h2 { color: #00ffcc; text-align: center; }
table { border-collapse: collapse; width: 90%; margin: 1em auto; }
th, td { border: 1px solid #555; padding: 4px 8px; text-align: left; }
tr:nth-child(even){ background:#1e1e20; }
</style>
<meta http-equiv="refresh" content="2">
<script>
async function switchMode(m){
  const res = await fetch('/api/mode', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({mode:m})
  });
  const data = await res.json();
  if(!res.ok || !data.ok){
    alert('�ؑ֎��s: ' + (data.error || res.status));
  }else{
    location.reload();
  }
}
</script>
<script>
async function loadRefeedOptions(){
  const select = document.getElementById('refeedSelect');
  if(!select) return;
  const toast = document.getElementById('refeedToast');
  try{
    const res = await fetch('/api/paper/refeed_list');
    if(!res.ok){
      throw new Error('list failed');
    }
    const data = await res.json();
    select.innerHTML = '';
    (data.db_files || []).forEach(function(fn){
      const opt = document.createElement('option');
      opt.value = fn;
      opt.textContent = fn;
      select.appendChild(opt);
    });
    if(data.current){
      select.value = data.current;
    }
    select.onchange = async function(ev){
      const filename = ev.target.value;
      try{
        const resp = await fetch('/api/paper/set_refeed', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({filename})
        });
        const payload = await resp.json();
        if(!resp.ok || payload.ok === false){
          throw new Error(payload.error || resp.status);
        }
        showToast('Refeed DB updated');
      }catch(err){
        showToast('Refeed DB update failed: ' + err, true);
      }
    };
  }catch(err){
    console.error(err);
    showToast('Failed to load refeed list: ' + err, true);
  }
}
function showToast(message, isError){
  const toast = document.getElementById('refeedToast');
  if(!toast){
    alert(message);
    return;
  }
  toast.textContent = message;
  toast.style.display = 'inline';
  toast.style.color = isError ? '#ff6961' : '#00ffcc';
  setTimeout(function(){ toast.style.display = 'none'; }, 2500);
}
document.addEventListener('DOMContentLoaded', loadRefeedOptions);
</script>
</head>
<body>
<h2>Sentinel Debug Dashboard</h2>
<h3 style="text-align:center;">
  MODE: <span style="color:#00ffcc">{{ mode.value }}</span>
  <small>(updated {{ mode.updated }})</small>
</h3>
<div style="text-align:center; margin: 0.5em 0 1.5em;">
  <button onclick="switchMode('LIVE-DRY')">LIVE-DRY</button>
  <button onclick="switchMode('LIVE')">LIVE</button>
  <button onclick="switchMode('PAPER')">PAPER</button>
</div>
{% if mode.value == 'PAPER' %}
<div style="text-align:center; margin-bottom:1em;">
  <label for="refeedSelect">Refeed DB:</label>
  <select id="refeedSelect" style="min-width:260px;"></select>
  <span id="refeedToast" style="margin-left:1em; color:#00ffcc; display:none;"></span>
  <div style="font-size:0.9em; margin-top:0.3em;">Current: {{ paper_refeed_current or 'unset' }}</div>
</div>
{% endif %}
<p style="text-align:center;">Updated: {{ now }}</p>

<h3>ランナー一覧</h3>
<table>
<tr><th>ID</th><th>Symbol</th><th>Mode</th><th>Last Seen</th></tr>
{% for rid, info in runners.items() %}
<tr><td>{{ rid }}</td><td>{{ info.symbol }}</td><td>{{ info.mode }}</td><td>{{ info.last_seen }}</td></tr>
{% endfor %}
</table>

<h3>口座情報</h3>
<p style="margin-left:2em;">
  Cash: {{ funds.cash }} /
  PnL: {{ funds.pnl_today }} /
  Updated: {{ funds.updated_at }} /
  OK: {{ funds.ok }}
</p>

<h3>RESTキュー</h3>
<p style="margin-left:2em;">
  Requests: {{ queue.requests }} /
  Processed: {{ queue.processed }} /
  Dropped: {{ queue.dropped }}
</p>

<h3>PUSH登録状況</h3>
<p style="margin-left:2em;">
  登録中: {{ queue.push_registered }}
</p>

<h3>通信履歴</h3>
<table>
<tr><th>時刻</th><th>種別</th><th>内容</th><th>OK</th></tr>
{% for entry in comms %}
<tr>
  <td>{{ entry.ts }}</td>
  <td>{{ entry.kind }}</td>
  <td>{{ entry.detail }}</td>
  <td>{{ entry.ok }}</td>
</tr>
{% endfor %}
</table>
</body>
</html>
